# secure-backup: Go Implementation - Continuation Guide

## Project Overview

**Goal**: Reimplement the bash backup script in Go with enhanced features for Docker volume backups.

**Current State**: Phase 1 COMPLETE âœ… - Core backup functionality fully implemented and tested.

**Your Mission**: Continue with Phase 2 (Docker Integration) or handle feature requests/bugs.

---

## What's Been Completed (Phase 1)

### Fully Functional Commands

1. **backup** - Creates TARâ†’COMPRESSâ†’ENCRYPT pipeline
   - Source: `cmd/backup.go`, `internal/backup/backup.go`
   - Features: GPG encryption, gzip compression, retention management
   - Flags: `--source`, `--dest`, `--public-key`, `--retention`, `--verbose`

2. **restore** - DECRYPTâ†’DECOMPRESSâ†’EXTRACT pipeline
   - Source: `cmd/restore.go`, `internal/backup/restore.go`
   - Features: Full decryption, decompression, tar extraction
   - Flags: `--file`, `--dest`, `--private-key`, `--passphrase`, `--verbose`

3. **verify** - Backup integrity checking
   - Source: `cmd/verify.go`, `internal/backup/verify.go`
   - Modes: Quick (header check) and Full (complete pipeline verification)
   - Flags: `--file`, `--quick`, `--private-key`, `--verbose`

4. **list** - View available backups
   - Source: `cmd/list.go`, `internal/retention/policy.go`
   - Features: Sorted by time, human-readable sizes and ages
   - Flags: `--dest`, `--pattern`

### Architecture Components

All core modules are implemented with streaming architecture:

**Encryption** (`internal/encrypt/`)
- Interface: `Encryptor` (encrypt.go)
- Implementation: `GPGEncryptor` (gpg.go) using `golang.org/x/crypto/openpgp`
- Factory: `NewEncryptor()` with method selection ("gpg", "age" placeholder)
- Tests: `gpg_test.go` (28.6% coverage - focuses on error cases)

**Compression** (`internal/compress/`)
- Interface: `Compressor` (compress.go)
- Implementation: `GzipCompressor` (gzip.go) using stdlib `compress/gzip`
- Default level: 6 (good balance)
- Factory: `NewCompressor()` with method selection
- Tests: `gzip_test.go` (76.9% coverage) âœ…

**Archiving** (`internal/archive/`)
- TAR creation and extraction (tar.go)
- Security: Path traversal protection, symlink handling
- Metadata preservation: permissions, ownership, timestamps
- Tests: `tar_test.go` (72.5% coverage) âœ…

**Backup Orchestration** (`internal/backup/`)
- Main pipeline: `backup.go`, `restore.go`, `verify.go`
- Streaming via `io.Pipe` for memory efficiency
- Tests: `backup_test.go` (65.7% coverage) âœ…

**Retention Management** (`internal/retention/`)
- Policy-based cleanup (policy.go)
- File listing with metadata
- Pattern matching for backup files
- Tests: `policy_test.go` (58.2% coverage) âœ…

### Critical Design Decisions

**1. Compress-Before-Encrypt Pipeline** ðŸ”¥
```
BACKUP:  TAR â†’ COMPRESS â†’ ENCRYPT
RESTORE: DECRYPT â†’ DECOMPRESS â†’ EXTRACT
```
**Why**: Encrypted data is cryptographically random and incompressible. Wrong order = 0% compression!

**2. Streaming Architecture**
- All pipeline stages use `io.Reader`/`io.Writer`
- `io.Pipe()` connects stages
- Constant memory usage regardless of backup size (10-50 MB typical)

**3. Interface-Based Extensibility**
- Easy to add new encryption methods (age in Phase 4)
- Easy to add new compression (zstd in Phase 3)
- No breaking changes to existing backups

**4. Security First**
- Path traversal protection in tar extraction
- Validation of tar paths (no `..`, no absolute paths)
- Proper error propagation throughout pipeline

### Test Coverage

- **Overall**: ~45-60% (core modules 60-75%)
- **compress**: 76.9% âœ…
- **archive**: 72.5% âœ…
- **backup**: 65.7% âœ…
- **retention**: 58.2% âœ…
- **encrypt**: 28.6% (interface tests only, full GPG tests skipped due to key generation issues)
- **cmd**: 0% (CLI integration tests not implemented)

### Dependencies

```go
require (
    github.com/spf13/cobra v1.10.2          // CLI framework
    golang.org/x/crypto v0.47.0             // OpenPGP encryption
    github.com/stretchr/testify v1.11.1     // Test assertions (dev)
)
```

**Zero external dependencies** for core functionality (tar, gzip, GPG all native Go).

---

## Project Structure

```
secure-backup/
â”œâ”€â”€ cmd/                    # Cobra CLI commands
â”‚   â”œâ”€â”€ root.go            # Root command setup
â”‚   â”œâ”€â”€ backup.go          # backup subcommand âœ…
â”‚   â”œâ”€â”€ restore.go         # restore subcommand âœ…
â”‚   â”œâ”€â”€ verify.go          # verify subcommand âœ…
â”‚   â””â”€â”€ list.go            # list subcommand âœ…
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ archive/
â”‚   â”‚   â”œâ”€â”€ tar.go         # TAR operations âœ…
â”‚   â”‚   â””â”€â”€ tar_test.go    # Tests âœ…
â”‚   â”œâ”€â”€ compress/
â”‚   â”‚   â”œâ”€â”€ compress.go    # Compressor interface âœ…
â”‚   â”‚   â”œâ”€â”€ gzip.go        # Gzip implementation âœ…
â”‚   â”‚   â””â”€â”€ gzip_test.go   # Tests âœ…
â”‚   â”œâ”€â”€ encrypt/
â”‚   â”‚   â”œâ”€â”€ encrypt.go     # Encryptor interface âœ…
â”‚   â”‚   â”œâ”€â”€ gpg.go         # GPG implementation âœ…
â”‚   â”‚   â””â”€â”€ gpg_test.go    # Tests âœ…
â”‚   â”œâ”€â”€ backup/
â”‚   â”‚   â”œâ”€â”€ backup.go      # Backup orchestration âœ…
â”‚   â”‚   â”œâ”€â”€ restore.go     # Restore orchestration âœ…
â”‚   â”‚   â”œâ”€â”€ verify.go      # Verification logic âœ…
â”‚   â”‚   â””â”€â”€ backup_test.go # Tests âœ…
â”‚   â””â”€â”€ retention/
â”‚       â”œâ”€â”€ policy.go      # Retention management âœ…
â”‚       â””â”€â”€ policy_test.go # Tests âœ…
â”œâ”€â”€ main.go                # Entry point âœ…
â”œâ”€â”€ go.mod                 # Dependencies âœ…
â”œâ”€â”€ go.sum                 # Dependency checksums âœ…
â”œâ”€â”€ README.md              # Project overview âœ…
â”œâ”€â”€ USAGE.md               # Detailed user guide âœ…
â””â”€â”€ prompt.txt             # This file âœ…
```

---

## Phase 2: Docker Integration (NEXT STEPS)

### Goal
Enable backup of Docker volumes with native Docker SDK integration.

### Key Tasks

#### 1. Docker Client Integration

**Create** `internal/docker/client.go`:
```go
package docker

import (
    "context"
    "github.com/docker/docker/client"
)

type VolumeInfo struct {
    Name       string
    MountPoint string
    Driver     string
    Size       int64
}

// ListVolumes retrieves all Docker volumes
func ListVolumes(ctx context.Context) ([]VolumeInfo, error) {
    // Use docker/docker/client SDK
}

// GetVolumePath returns the filesystem path for a volume
func GetVolumePath(ctx context.Context, volumeName string) (string, error) {
    // Locate volume mount point
}
```

**Dependencies to add**:
```bash
go get github.com/docker/docker/client
```

#### 2. Enhance Backup Command

**Modify** `cmd/backup.go`:
- Add `--volume` flag for Docker volume names
- Add `--pause` flag to pause containers during backup
- Add `--restart` flag to stop/restart containers

**Logic**:
1. If `--volume` is set, use Docker SDK to find volume path
2. If `--pause` is set, pause container(s) using the volume
3. Perform backup as normal
4. Resume/restart containers

#### 3. Volume Discovery Command

**Create** `cmd/volumes.go`:
```bash
secure-backup volumes list  # List all Docker volumes
secure-backup volumes info <volume-name>  # Show volume details
```

#### 4. Container Management

**Create** `internal/docker/container.go`:
```go
// PauseContainer pauses a running container
func PauseContainer(ctx context.Context, containerID string) error

// UnpauseContainer resumes a paused container
func UnpauseContainer(ctx context.Context, containerID string) error

// FindContainersUsingVolume finds containers using a specific volume
func FindContainersUsingVolume(ctx context.Context, volumeName string) ([]string, error)
```

#### 5. Integration Testing

**Create** `internal/docker/docker_test.go`:
- Use `testcontainers-go` for real Docker integration tests
- Test volume discovery
- Test container pause/unpause
- Test full backupâ†’restore cycle with Docker volumes

**Install test dependencies**:
```bash
go get github.com/testcontainers/testcontainers-go
```

### Implementation Order (Suggested)

1. **Docker Client** - Basic volume listing and path resolution
2. **Volume Backup** - Extend backup command with `--volume` flag
3. **Container Management** - Pause/unpause functionality
4. **Volume Discovery** - List/info commands
5. **Integration Tests** - Comprehensive Docker tests
6. **Documentation** - Update README and USAGE.md with Docker examples

---

## Common Development Tasks

### Building

```bash
go build -o secure-backup .
```

### Running Tests

```bash
# All tests
go test ./...

# With coverage
go test ./... -coverprofile=coverage.out
go tool cover -html=coverage.out

# Specific package
go test ./internal/compress -v

# Run specific test
go test ./internal/compress -run TestGzipCompressor_CompressDecompress
```

### Linting

```bash
# Install golangci-lint
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# Run linter
golangci-lint run
```

### Manual Testing

```bash
# Build
go build -o secure-backup .

# Test backupâ†’restore cycle
mkdir -p /tmp/test-source /tmp/test-backups /tmp/test-restore
echo "test data" > /tmp/test-source/test.txt

# 1. Export test GPG key (if not already done)
gpg --gen-key  # Generate test key
gpg --export test@example.com > /tmp/test-pub.asc
gpg --export-secret-keys test@example.com > /tmp/test-priv.asc

# 2. Backup
./secure-backup backup \
  --source /tmp/test-source \
  --dest /tmp/test-backups \
  --public-key /tmp/test-pub.asc \
  -v

# 3. List
./secure-backup list --dest /tmp/test-backups

# 4. Verify
./secure-backup verify \
  --file /tmp/test-backups/backup_*.tar.gz.gpg \
  --private-key /tmp/test-priv.asc \
  -v

# 5. Restore
./secure-backup restore \
  --file /tmp/test-backups/backup_*.tar.gz.gpg \
  --dest /tmp/test-restore \
  --private-key /tmp/test-priv.asc \
  -v

# 6. Verify restored content
diff /tmp/test-source/test.txt /tmp/test-restore/test-source/test.txt
```

---

## Important Context Files

The user has requested comprehensive planning and documentation:

### Artifacts in `.gemini/antigravity/brain/<conversation-id>/`

1. **task.md** - Task breakdown and progress tracking
2. **implementation_plan.md** - Detailed architectural decisions and plan
3. **compression_analysis.md** - Analysis of compression algorithms and pipeline order
4. **age_vs_gpg_comparison.md** - Encryption method comparison
5. **walkthrough.md** - Phase 1 completion summary

**Read these first** to understand the full context and design decisions!

---

## Known Issues and Limitations

### Current Limitations

1. **GPG Key Management**: Requires explicit key paths
   - Future: Integrate with system GPG keyring for auto-discovery
   
2. **No Progress Indicators**: Large backups have no progress feedback
   - Future: Add progress bars using a progress library

3. **No Parallel Compression**: Single-threaded compression
   - Future: Consider `pgzip` for parallel gzip compression

4. **CLI Tests Missing**: cmd/ package has 0% coverage
   - Future: Add CLI integration tests

5. **GPG Test Coverage Low**: Full encryption round-trip tests fail due to OpenPGP hash function issues
   - Current: Tests focus on error cases and interfaces
   - Future: Investigate alternative test key generation or mock OpenPGP

### Docker-Specific Challenges (Phase 2)

1. **Permissions**: Docker volumes typically require root access
2. **Live Backups**: Need to handle data consistency during backup
3. **Container State**: Must properly manage container lifecycle

---

## Code Style and Conventions

Follow standard Go conventions:

```go
// Package documentation
package mypackage

// Public function with doc comment
// CamelCase for exports
func DoSomething(input string) (string, error) {
    // Variables are camelCase
    myVar := "value"
    
    // Error handling first
    if err := validate(input); err != nil {
        return "", fmt.Errorf("validation failed: %w", err)
    }
    
    // Return explicit errors
    return result, nil
}

// Private function
func helperFunction() {
    // ...
}
```

**Error handling**: Always wrap errors with context using `fmt.Errorf("context: %w", err)`

**Testing**: Use table-driven tests with subtests:
```go
func TestMyFunction(t *testing.T) {
    tests := []struct {
        name     string
        input    string
        expected string
    }{
        {"case 1", "input1", "output1"},
        {"case 2", "input2", "output2"},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            result := MyFunction(tt.input)
            assert.Equal(t, tt.expected, result)
        })
    }
}
```

---

## User Expectations

The user (Marko) values:

1. **Unit tests first**: Test coverage is a priority (target 80%+)
2. **Native Go**: Avoid `os.Exec` where possible
3. **Scalability**: Design for future features (age, zstd, etc.)
4. **Clean architecture**: Interface-based, composable design
5. **Documentation**: Comprehensive docs for users and future developers

---

## Quick Reference Commands

```bash
# Build
go build -o secure-backup .

# Test
go test ./...

# Test with coverage
go test ./... -coverprofile=coverage.out && go tool cover -func=coverage.out

# Run
./secure-backup --help
./secure-backup backup --help
./secure-backup restore --help
./secure-backup verify --help
./secure-backup list --help

# Install locally
go build -o secure-backup . && sudo mv secure-backup /usr/local/bin/

# Format code
go fmt ./...

# Tidy dependencies
go mod tidy

# View module graph
go mod graph
```

---

## Questions to Ask the User

Before starting Phase 2, clarify:

1. **Docker Socket Access**: Should the tool require running as root, or use Docker socket permissions?
2. **Volume Backup Strategy**: Direct path access (current plan) vs. docker cp vs. docker run mount?
3. **Container Pause Safety**: Should pause be opt-in (--pause flag) or opt-out?
4. **Priority Features**: Which Phase 2 features are most important (volume backup, pause/restart, discovery)?

---

## Success Criteria for Phase 2

- [ ] Docker SDK integrated
- [ ] `backup --volume <name>` works for Docker volumes
- [ ] `volumes list` shows all Docker volumes
- [ ] `--pause` flag pauses containers during backup
- [ ] Integration tests with testcontainers-go
- [ ] Documentation updated with Docker examples
- [ ] Test coverage maintained above 60%

---

## Additional Resources

- **Docker SDK Docs**: https://pkg.go.dev/github.com/docker/docker/client
- **Testcontainers**: https://golang.testcontainers.org/
- **Cobra CLI Guide**: https://github.com/spf13/cobra
- **OpenPGP Package**: https://pkg.go.dev/golang.org/x/crypto/openpgp

---

**Good luck with Phase 2! Remember to read the artifacts in `.gemini/antigravity/brain/` for full context.**
